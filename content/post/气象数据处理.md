---
title: "数据处理-气象数据-01
"
date: 2018-05-09T 00:16:59+08:00
draft: True
tags: ["R","数据处理","绘图"]
share: true
---

<!--more-->



一、大体背景介绍
========================================================
由于直接观测数据难以覆盖全面，希望能补充部分数据源，现需对开放的再分析数据进行简单分析。
- 提取
需求目标：从某种再分析数据源当中提取全国气象自动监测站点的数据，获取相应站点日数据。
涉及到几个气象要素：日均气温、日降水、日相对湿度、日辐射、日风速、日最大气温、日最小气温等七个要素。

- 已有资源及数据情况：  
数据源：格式-nc文件，空间分辨率0.125°的网格，时间分辨率小于24小时，时间跨度10年，总文件大小60G左右

- 处理分析
将再分析数据与观测站的数据进行比较，采用均方根误差RMSE作为指标，以月均值为主要对象，区域范围包括中国。

二、数据提取、处理、
========================================================
提取的前提是对数据源的了解，明确单位、精度、气象要素的正常值范围等。
准备的文件：全国主要观测站点的经纬度坐标，格式csv/txt等。

大体的流程图如下：

![alt text](/img/figure_m2/flow1.png)


2.1 提取的代码块1
========================================================
简单提取程序脚本如下图：

![alt text](/img/figure_m2/py1.PNG)


2.2 异常值和缺失值的代码块1
========================================================
异常与缺失处理：


```
{python}
# find missing value && put NaN
missing = df.ix[(df[df.columns[7]] == 32766)]
#print('########temperature missing########')
for index, row in missing.iterrows():
    #print(row[0], row[4], row[5], row[6], row[7])
    print(index)
df[df == 32766] = np.nan
# get temperature
tmp = df[df.columns[7]] * 0.1
```


2.3 要素转换的代码块1
========================================================
主要是对将辐射转成日照时长。

```
{python}
def dursun(lat_deg, dt):
    
    t = 24.0/pi*(acos(-tan(lat_rad)*tan(theta)))
    return t

def Ra():

    Ra = 24 * 60 * Gsc * dr * ( (ws * sin(lat_rad) * sin(delta)) + ( cos(lat_rad) * cos(delta) * sin(ws))) / pi
    return Ra

```
2.4 数据提取结果
========================================================
考虑存在csv格式文件，文件数量=7个气象要素×194个站点，大小200多Mb。

<center> ![再分析数据提取结果](/img/figure_m2/file1.PNG)

三、数据分析
========================================================
准备的数据：  
1. 约200个站点的再分析日值数据（即从nc文件中提取出来，并清洗、转换好）；  
2. 约200个站点的观测站日值数据。  
3. 全国观测站点的经纬度坐标信息。  

上述数据均保存在csv文件当中，统一保存的编码格式。  

比较累年月值（12个月），月值（某年某月），累年值（某年）等的再分析数据对比观测站数据的误差情况。  

数据组织与流向如下图：


|源  | 要素（温度、湿度等）|时间分辨率  | 文件数量及大小|
|------------- | -------------|------------- | -------------|
|再分析  | ... |10年日值  | 1300个左右，200-300M |
|观测站  | ... |10年日值  | 194个，100M左右 |

3.1 文件与数据管理
========================================================
数据组织变化涉及几个步骤，以其中一个要素分析为例说明如下：

![alt text](/img/figure_m2/file_struction.png)



3.2 数据分析处理与输出
========================================================


```
{python}

CMA_datasource_dir = '/media/dira/'
station_194_dir = '/media/latlon.csv'
df = pd.read_csv(station_194_dir, header=0, sep=',')
star_time = datetime(2004, 1, 1).strftime('%Y-%m-%d')
end_time = datetime(2016, 7, 31).strftime('%Y-%m-%d')

# 2、读入194个CMA观测数据
val_3 = os.popen("find /media/dir2 -name '%s*'" \
                 % (stid)).read()
#年份、月份提取
obs_vlu_m = grouped_by_month.mean()
```

3.4 数据分析处理与输出
========================================================
对应累积年值的计算结果,包含194个站点1-12个月的对应RSEM、相关系数等。

![alt text](/img/figure_m2/file3.PNG)



四、数据观测与图表绘制
========================================================

### 1. 观测多个站点在不同时间尺度上的误差分布，误差分布与海拔高度间关系。
### 2. 空间分布上不同站点的情况。

### **准备的数据：**  

1. 某个要素的约200个站点的误差及相关系数数据  

2. 工具平台：R、GIS、python  


4.1 简单频次分布图
========================================================
对数据中的RSME绘制简单的分布图

![简单分布图](/img/figure_m2/Daily_h.png)





4.2 时间序列分布图
========================================================

多个站点的月值图
![多个站点累积月值](/img/figure_m2/month_help_value.png)


4.3 空间分布图
=====================
在python上简单绘制的结果
![py绘制的map](/img/figure_m2/map_py.png)
***
借助GIS绘制的结果
![gis绘制的map](/img/figure_m2/map_gis.png)

4.4 简单结论
=======================================================


 1.　温度日值、月值的准确性较高，整体上和观测值基本相符，在具体应用时需区分不同地区  

 2.　准确性较低的区域原因：
  +  受复杂地形等因素所影响
  +  另一方面可能是观测数据本身站点少、观测质量

五、小案例线性回归
========================================================
如何在已有数据基础之上，筛除异常值，并得到最终拟合曲线

[线性回归拟合-示例](/img/guides/guide_x/for_404.html)


